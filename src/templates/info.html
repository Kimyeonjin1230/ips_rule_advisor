<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../static/vars/vars.css">
  <link rel="stylesheet" href="../static/styles/getinfo_result.css">
  <style>
    a,
    button,
    input,
    select,
    h1,
    h2,
    h3,
    h4,
    h5,
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        border: none;
        text-decoration: none;
        background: none;
        -webkit-font-smoothing: antialiased;
    }

    menu,
    ol,
    ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }

    .chat-inputbox {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #ffffff;
        box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.1);
        justify-content: space-between;
    }

    .chat-inputbox form {
        display: flex;
        align-items: center;
        width: 100%;
    }

    .chat-inputbox input {
        flex-grow: 1;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid #ccc;
        outline: none;
        margin-right: 10px;
    }

    .chat-inputbox button {
        padding: 10px;
        border-radius: 50%;
        color: #fff;
        cursor: pointer;
        border: none;
    }

    .chat-inputbox button img {
        width: 20px;
    }

    .chat-wrapper {
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
    }

    .chat-message {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 10px;
        max-width: 70%;
    }

    .chat-message.user {
        background-color: #e0f7fa;
        margin-left: auto;
        text-align: right;
    }

    .chat-message.gpt {
        background-color: #70a50e;
        margin-right: auto;
        text-align: left;
    }
</style>
  <title>IPS Rule Advisor</title>
</head>
<body>
  <div class="layout-wrapper">
    <header class="header">
      <div class="header-logo">
        <div class="logo">
          <img class="hdd-fill" src="../static/vectors/logo-hdd-fill0.svg" />
          <img class="shield-plus" src="../static/vectors/logo-shield-plus0.svg" />
        </div>
      </div>
      <div class="header-nav">
        <a class="nav-item--active item-text" href="../static/pages/html/getinfo_search.html">정보수집</a>
        <a class="nav-item item-text" href="../static/pages/html/ruletest.html">룰 테스트</a>
        <!--<a class="nav-item item-text" href="">마이페이지</a> -->
      </div>
      <div class="header-auth">
        <div class="auth-profile">
          <div class="avatar-img">
            <img class="shape" src="../static/images/avatar-0.png"/>
          </div>
          <div class="profile-name">
            <div class="text-name">YSD 님</div>
          </div>
        </div>
      </div>
    </header>
    <div class="main-container">
      <div class="card-cve">
        <div class="card__title">{{ info.nvd.id | default('정보 없음') }}</div>
        <div class="line-seperate"></div>
        <div class="card__text">게시일 : 2022-03-03 | 최종 수정일 : 2023-04-20</div>
        <div class="card__text">취약점 유형 : {{ type | default('정보 없음') }}</div>
        <div class="card__text">{{ info.nvd.설명 | default('정보 없음') }}</div>
      </div>

      <div class="card-cpe">
        <div class="card__title">영향받는 제품</div>
        <div class="table">
          <div class="table-header">
            <div class="table-grid-03">
              <div class="table__cell-03 text-cell">공급업체</div>
              <div class="table__cell-03 text-cell">제품</div>
              <div class="table__cell-03 text-cell">버전</div>
            </div>
          </div>
          <div class="table-row">
          {% if info.nvd.제품들 %}
            {% for cpe_list in info.nvd.제품들 %}
                {% for cpe in cpe_list %}
                    <div class="table-grid-03">
                        <div class="table__cell-03 text-cell">{{ cpe.CPE | default('정보 없음') }}</div>
                        <div class="table__cell-03 text-cell">{{ cpe.포함 if cpe.포함 is not none else '-' }}</div>
                        <div class="table__cell-03 text-cell">{{ cpe.비포함 if cpe.비포함 is not none else '-' }}</div>
                    </div>
                {% endfor %}
            {% endfor %}
        {% else %}
            <p>정보가 없습니다.</p>
        {% endif %}
          </div>
        </div>
      </div>

      <div class="card-cvss">
        <div class="card__title">CVSS</div>
        <div class="line-seperate"></div>
        <div class="tab-container">
          <div class="tab-item--unselected text-tab--unselected">CVSS 2.0</div>
          <div class="tab-item--selected text-tab--selected">CVSS 3.x</div>        
        </div>
        <div class="card__text">
          메트릭 : {{ info.nvd.메트릭 | default('정보 없음') }}
        </div>
        <div class="table">
          <div class="table-header">
            <div class="table-grid-03">
              <div class="table__cell-03 text-cell">기본 점수</div>
              <div class="table__cell-03 text-cell">악용 가능성 점수</div>
              <div class="table__cell-03 text-cell">영향 점수</div>
            </div>
          </div>
          <div class="table-row">
            <div class="table-grid-03">
              <div class="table__cell-03 text-cell">{{ info.nvd.점수 | default('정보 없음') }}</div>
            </div>
          </div>
        </div>
        <div class="card__subtitle">메트릭 요약</div>
        <div class="card__text">{{ metrics_summary | default('정보 없음') }}</div>
      </div>

      <div class="card-rule">
        <div class="card__title">연관 IPS Rule</div>
        <div class="line-seperate"></div>
        <div class="card__row">
          <div class="card__subtitle">공격 유형</div>
          <div class="dropdown-field">
            <select class="dropdown-select" name="" id="">
              <option class="dropdown-item text-dropdown-item" value="SQL Injection">SQL Injection</option>
              <option class="dropdown-item text-dropdown-item" value="XSS">XSS</option>
            </select>
          </div>
        </div>
        <div class="card__rulebox">
          <div class="text-rulebox">
            {{ type | default('정보 없음') }}
          </div>
        </div>
        <div class="card__row">
          <div class="card__subtitle">영향받는 제품</div>
          <div class="dropdown-field">
            <select class="dropdown-select" name="" id="">
              <option class="dropdown-item text-dropdown-item" value="SQL Injection">abc</option>
              <option class="dropdown-item text-dropdown-item" value="XSS">xyz</option>
            </select>
          </div>
        </div>
        <div class="card__rulebox">
          <div class="text-rulebox">
            alert http any any -&gt; 192.168.1.0/24 any (msg:&quot;Detect SQL
            injection attempt&quot;; http.uri; content:&quot;SELECT&quot;;
            sid:1000004; rev:1;)
          </div>
        </div>
      </div>

      <div class="card-gpt">
        <div class="card__title">ChatGPT 프롬프트</div>
        <div class="chat-inputbox">
          <div class="icon-paperclip">
            <img class="paperclip" src="../static/vectors/icon-paperclip.svg" />
          </div>
          <form id="chat-form">
            <input class="input-text" id="user-input" name="user-input" type="text" placeholder="메시지 to ChatGPT..." />
            <div class="icon-send">
              <button type="submit" class="chat-send-button">
                <img class="send" src="../static/vectors/icon-send.svg" />
              </button>
            </div>
          </form>
        </div>
        
        <div class="chat-wrapper">
          <div class="message-gpt">
            <div class="message-box-left">
              <div class="message-box__avatar">
                <img class="chat-gpt" src="../static/vectors/icon-chat-gpt.svg" />
              </div>
              <div class="message-box__bubble">
                <div class="bubble-tip-gpt">
                  <img class="bubble-tip-gpt" src="../static/vectors/bubble-tip-gpt.svg" />
                  <div class="bottom-curve-rectangle-gpt"></div>
                  <img
                    class="bottom-curve-vector-gpt"
                    src="../static/vectors/bottom-curve-vector-gpt.svg"
                  />
                </div>
                <div class="bubble-message-gpt">
                  <div class="message-frame-gpt">
                    <div class="message__title">
                      <div class="text-message-name">ChatGPT</div>
                    </div>
                    <div class="message__body">
                      <div class="text-message-gpt">
                        <!-- Chat Section -->
                          <div class="chat-container">
                            <div class="chat-box" id="chat-box">
                              <!-- 대화 내용이 여기에 표시됩니다. -->
                            </div>
                            <form id="chat-form">
                              <div class="chat-inputbox">

                              </div>
                            </form>
                          </div>

                      </div>

                    </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="message-my">
            <div class="message-box-right">
              <div class="bubble-tip-my">
                <img class="bubble-tip-my" src="../static/vectors/bubble-tip-my.svg"/>
                <div class="bottom-curve-rectangle-my"></div>
                <img
                  class="bottom-curve-vector-my"
                  src="../static/vectors/bottom-curve-vector-my.svg"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card-poc">
        <div class="card__title">POC (Proof of Concept)</div>
        <div class="line-seperate"></div>
        <div class="card__text">POC 총 링크 수 : {{ info.nvd.poc|length }}</div>
        <div class="table">
            <div class="table-row">
                <div class="table-grid-03">
                    <div class="table__cell-03 text-cell">
                        <div class="section">
                            {% if info.nvd.poc %}
                            <ul>
                                {% for poc in info.nvd.poc %}
                                <li><a href="{{ poc.url }}" target="_blank">{{ poc.url }}</a> - {{ poc.tags | join(', ') | default('정보 없음') }}</li>
                                {% endfor %}
                            </ul>
                            {% else %}
                            <p>정보가 없습니다.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-ref">
        <div class="card__title">참고자료</div>
        <div class="line-separate"></div>
        <div class="table">
            <div class="table-header">
                <div class="table-grid-03">
                    <div class="table__cell-03 text-cell">링크</div>
                    <div class="table__cell-03 text-cell">유형</div>
                </div>
            </div>
            <div class="table-row">
                <div class="table-grid-03">
                    <div class="table__cell-03 text-link">
                        {% if info.nvd.참고자료 %}
                        <ul>
                            {% for ref in info.nvd.참고자료 %}
                            <li><a href="{{ ref.url }}" target="_blank">{{ ref.url }}</a></li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p>정보가 없습니다.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="main-row">
        <div class="button-group">
            <button class="button-neutral text-button--neutral">뒤로</button>
            <button class="button-primary text-button--primary">룰 테스트</button>
        </div>
    </div>
    
  

  <script>
    const chatBox = document.getElementById('chat-box');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    // 메시지를 채팅 박스에 추가하는 함수
    function addMessage(content, sender) {
        const message = document.createElement('div');
        message.classList.add('chat-message');
        if (sender === 'user') {
            message.classList.add('user');
        }
        else {
          message.classList.add('gpt');
        }
        message.textContent = content;
        chatBox.appendChild(message);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 폼 제출 이벤트 핸들러
    chatForm.addEventListener('submit', async function(event) {
    event.preventDefault();
    const userMessage = userInput.value;
    if (userMessage.trim() === '') return;

    addMessage(userMessage, 'user');
    userInput.value = '';

    try {
        const response = await fetch('/openai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: userMessage })
        });

        const data = await response.json();
        addMessage(data.reply, 'gpt');

    } catch (error) {
        console.error('Error:', error);
        addMessage('chatGPT와 연결이 되지 않았습니다.', 'gpt');
    }
});
</script>
</body>
</html>
        
